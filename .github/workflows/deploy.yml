name: Deploy AWS Cost Reporter

on:
  workflow_dispatch:
    inputs:
      webhook_endpoint:
        description: 'Webhook endpoint URL (optional)'
        required: false
        type: string
      notification_email:
        description: 'Email for notifications (optional)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Bootstrap (if needed)
        run: npx cdk bootstrap

      - name: CDK Synth
        run: npx cdk synth
        env:
          WEBHOOK_ENDPOINT: ${{ inputs.webhook_endpoint || vars.WEBHOOK_ENDPOINT }}
          NOTIFICATION_EMAIL: ${{ inputs.notification_email || vars.NOTIFICATION_EMAIL }}

      - name: CDK Deploy
        run: npx cdk deploy --require-approval never
        env:
          WEBHOOK_ENDPOINT: ${{ inputs.webhook_endpoint || vars.WEBHOOK_ENDPOINT }}
          NOTIFICATION_EMAIL: ${{ inputs.notification_email || vars.NOTIFICATION_EMAIL }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ vars.AWS_REGION || 'us-east-1' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Webhook**: ${WEBHOOK_ENDPOINT:-'Not configured'}" >> $GITHUB_STEP_SUMMARY
          echo "- **Email**: ${NOTIFICATION_EMAIL:-'Not configured'}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check AWS Console for stack outputs" >> $GITHUB_STEP_SUMMARY
          echo "2. If email configured, confirm SNS subscription" >> $GITHUB_STEP_SUMMARY
          echo "3. Test the API endpoint with manual trigger" >> $GITHUB_STEP_SUMMARY
        env:
          WEBHOOK_ENDPOINT: ${{ inputs.webhook_endpoint || vars.WEBHOOK_ENDPOINT }}
          NOTIFICATION_EMAIL: ${{ inputs.notification_email || vars.NOTIFICATION_EMAIL }}
